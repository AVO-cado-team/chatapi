<!DOCTYPE html>
<html lang="html">
<head>
    <title>Chat Client</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.js"
            integrity="sha512-tL4PIUsPy+Rks1go4kQG8M8/ItpRMvKnbBjQm4d2DQnFwgcBYRRN00QdyQnWSCwNMsoY/MfJY8nHp2CzlNdtZA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        const token = 'eyJhbGciOiJIUzUxMiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIzOmFjY2VzcyIsImlzcyI6ImFwcCIsImlhdCI6MTY4ODkyNzExNCwiZXhwIjoxNjkxOTUxMTE0fQ.b2FOlUtRP-wFXBZZ2fa3MauRGITc3vMnXqTFpULibGGaZjUc1RNKI699MLFKlA8TTcKpBsOLb6I5mtvG_pk66Q'
        const appPrefix = 'app';
        const userChatId = '1';
        const chatPathSend = (_userChatId = userChatId) => `/${appPrefix}/chat/${userChatId}/send`;
        // const chatPathSubscribe = (_userChatId=userChatId) => `/chat/${_userChatId}`;
        const url = 'ws://localhost:8080/room';

        const stompClient = Stomp.client(url);
        const headers = {
            'xxx': token,
        };
        stompClient.connect(headers, handleConnection);
        console.log("stompClient", stompClient);

        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = {
                content: messageInput.value
            };
            const messageChatId = document.getElementById('message-chat-id');
            const chatId = messageChatId.value;
            stompClient.send(chatPathSend(chatId), headers, JSON.stringify(message));
            console.log(`Try to send ${message} to ${chatPathSend(chatId)}`);
            messageInput.value = '';
        }

        function subscriberFactoryFunction(path) {
            return function (message) {
                console.log(`${path}: ${message?.body}`);
            }
        }

        function handleConnection(message) {
            console.dir(' @@@@@@@@@@@@@@@@@@@@@@@@@@2');
            initSendMessage();
            initSubscribeToChat();
        }

        function initSendMessage() {
            var sendButton = document.getElementById('send-button');
            sendButton.addEventListener('click', sendMessage);
            sendButton.disabled = false;
        }
        function initSubscribeToChat() {
            var subscribeButton = document.getElementById('subscribe-button');
            subscribeButton.addEventListener('click', subscribeToChat);
            subscribeButton.disabled = false;
        }

        function subscribeToChat() {
            var subscribeInput = document.getElementById('subscribe-input');
            const chatId = subscribeInput.value;
            const chatPathSubscribe = `/chat/${chatId}`;
            const subscription = stompClient.subscribe(chatPathSubscribe, subscriberFactoryFunction(chatPathSubscribe));
            console.log(`Try to subscribe to ${chatPathSubscribe} with subscription id ${subscription.id}`);
        }

    </script>
</head>
<body>
<h1>Chat Client</h1>

<div>
    <label for="message-input">Message:</label>
    <input type="text" id="message-input" placeholder="message">
    <input type="text" id="message-chat-id" placeholder="chatId">
    <button id="send-button" disabled>Send</button>
</div>
<!--Write a -->
<div>
    <label for="subscribe-input">ChatId:</label>
    <input type="text" id="subscribe-input">
    <button id="subscribe-button" disabled>Subscribe</button>
</div>
</body>
</html>