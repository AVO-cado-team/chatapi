<!DOCTYPE html>
<html lang="html">
<head>
    <title>Chat Client</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.js"
            integrity="sha512-tL4PIUsPy+Rks1go4kQG8M8/ItpRMvKnbBjQm4d2DQnFwgcBYRRN00QdyQnWSCwNMsoY/MfJY8nHp2CzlNdtZA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        var token = '';
        var appPrefix = 'app';
        var userChatId = '1';
        var headerTokenName = 'token';
        var chatPathSend = (_userChatId = userChatId) => `/${appPrefix}/chat/${_userChatId}/send`;
        var url = 'ws://localhost:8080/room';
        var stompClient;


        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = {
                content: messageInput.value
            };
            const messageChatIdInput = document.getElementById('message-chat-id');
            const chatId = messageChatIdInput.value;
            console.log("chatId", chatId);
            stompClient.send(chatPathSend(chatId), headers, JSON.stringify(message));
            console.log(`Try to send ${message} to ${chatPathSend(chatId)}`);
            messageInput.value = '';
            messageChatIdInput.value = '';
        }

        function subscriberFactoryFunction(path) {
            return function (message) {
                console.log(`${path}: ${message?.body}`);
            }
        }

        function handleConnection(message) {
            console.log(message);
            initSendMessage();
            initSubscribeToChat();
        }

        function initSendMessage() {
            var sendButton = document.getElementById('send-button');
            sendButton.addEventListener('click', sendMessage);
            sendButton.disabled = false;
        }
        function initSubscribeToChat() {
            var subscribeButton = document.getElementById('subscribe-button');
            subscribeButton.addEventListener('click', subscribeToChat);
            subscribeButton.disabled = false;
        }

        function subscribeToChat(options) {
            var subscribeInput = document.getElementById('subscribe-input');
            const chatId = subscribeInput.value;
            const chatPathSubscribe = `/chat/${chatId}`;
            const subscription = stompClient.subscribe(chatPathSubscribe, subscriberFactoryFunction(chatPathSubscribe));
            console.log(`Try to subscribe to ${chatPathSubscribe} with subscription id ${subscription.id}`);
        }

        function initSetToken() {
            const tokenButton = document.getElementById('token-button');
            tokenButton.addEventListener('click', setTokenAndConnect);
        }
        function setTokenAndConnect() {
            const tokenInput = document.getElementById('token-input');
            token = tokenInput.value;
            const headers = {
                [headerTokenName]: token,
            };
            stompClient = Stomp.client(url);
            stompClient.connect(headers, handleConnection);
            var stompClient2 = Stomp.client(url);
            stompClient2.connect(headers, handleConnection);
            console.log(`Try to connect to ${url} with token ${token}`);
        }

        setTimeout(() => {
            initSetToken();
        }, 1000);

    </script>
</head>
<body>
<h1>Chat Client</h1>

<div>
    <label for="message-input"> Message:</label>
    <input type="text" id="message-input" placeholder="message">
    <label for="message-chat-id"> Chat Id:</label><input type="text" id="message-chat-id" placeholder="chatId">
    <button id="send-button" disabled>Send</button>
</div>
<!--Write a -->
<div>
    <label for="subscribe-input">ChatId:</label>
    <input type="text" id="subscribe-input">
    <button id="subscribe-button" disabled>Subscribe</button>
</div>

<div style="float: right">
    <label for="token-input">Token:</label>
    <input type="text" id="token-input">
    <button id="token-button">Set token</button>
</div>
</body>
</html>